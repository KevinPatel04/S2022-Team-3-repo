{% extends 'template.html' %}
{% load static %}

{% block title %}
Reuse | greenCan
{% endblock %}

{% block style %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
<link rel="stylesheet" href="{% static 'css/map.css' %}" />
<link rel="stylesheet" href="{% static 'css/filter.css' %}" />
<link rel="stylesheet" href="{% static 'css/card.css' %}" />
{% endblock %}

{% block main %}
<div class="d-flex justify-content-md-center justify-content-sm-start">
    <h1 class="h1">Search for NGO Donation Sites</h1>
</div>

<div class="my-md-4 my-2 d-flex container-fluid justify-content-center pb-3 mx-auto">
    <div class="row justify-content-center">
        <div class="col-md-7 col-12 justify-content-center mb-1">
          <input type="number" class="form-control" id="zipcode"  value="" pattern="^[0-9]{5}$" min="0" maxlen="5" required placeholder="Enter Zip code">
          <div class="invalid-feedback justify-content-center d-none" id="zipcode-feedback">
                Please enter a valid 5 digit NYC zip code.
          </div>
        </div>
        <div class="col-md-2 col-12 justify-content-center mb-1">
            <div class="mx-md-4 mx-2 p-2 or-container">
                OR
            </div>
        </div>
        <div class="col-md-3 col-12 justify-content-center mb-1">
            <button class="btn btn-rounded" id="btn-locate-me">Locate Me</button>
        </div>
    </div>
</div>

<div class="row container-fluid px-0 mt-md-2">
    <div class="col-md-8 col-sm-10 col-12 offset-md-0 offset-sm-1 pr-2">
        <div id="map"></div>
    </div>
    <div class="col-md-4 col-sm-10 col-12 offset-md-0 offset-sm-1" >
        <div id="listings" class="card_frame">
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/maps.js' %}"></script>
<script>

    let result = {};
    let locations = {};
    function markPoints(locations){
        clearView();
        let marker;
        $.each(locations, function( key,site ) {
            marker = L.marker([site["latitude"],site["longitude"]],{icon: colorCategoryMap['public recycle bins'][0]});
            marker.bindTooltip(site["street_address"]+'<br/>'+site['state_id']+' '+site['zip_code'], {
                sticky: true
            }).addTo(map);            
            var card = '<div class="location-card container mb-2" onclick="focusOn('+site['latitude'].toString()+','+site['longitude'].toString()+')"> \
                <span class="float-right" data-toggle="tooltip" data-placement="left" title="Items Accepted: '+site['item_accepted'].toString()+'"><i class="fa fa-info-circle" style="color: #C4C4C4"></i></span> \
                <div class="address-wrapper text-green"> \
                    '+site['street_address']+', '+site['borough']+',<br> '+ site['state_id'] + ' ' + site['zip_code'] +' \
                </div>';
                if (site['phone_number'] != null && site['phone_number'] != '' && site['phone_number'] != undefined){
                    card+= '<div class="item-wrapper"> \
                            <i class="fa fa-phone"></i> <span class="text-black">+1 '+site['phone_number']+'</span> \
                        </div>';
                }

                if (site['email'] != null && site['email'] != '' && site['email'] != undefined){
                    card += '<div class="item-wrapper"> \
                            <i class="fa fa-envelope"></i> <span class="text-black">'+site['email']+'</span> \
                        </div>';
                }

                if (site['website'] != null && site['website'] != '' && site['website'] != undefined){
                    card += '<div class="item-wrapper"> \
                            <i class="fa fa-globe"></i> <span class="text-black"> <a target="_blank" href="'+site['website']+'">'+site['website']+'</a></span> \
                        </div>';
                }

                if (site['hours'] != null && site['hours'] != '' && site['hours'] != undefined){
                    card += '<div class="item-wrapper"> \
                            <i class="fa fa-clock"></i> <span class="text-black">'+site['hours']+'</span> \
                        </div>';
                }

                card += '<button class="btn btn-primary btn-outline mt-2" data-href="https://www.google.com/maps?saddr=My+Location&daddr='+site['latitude'].toString()+','+site['longitude'].toString()+'" target="_blank"> Get Directions</button> \
                        </div>';
            $('#listings').append($(card));
            markersLayer.addLayer(marker);
        });
    }
    
    function clearView() {
        if (map){
            markersLayer.clearLayers();
        }
        $('#listings').html('');
    }

    function setMap() {
      map = L.map('map').setView([latitude,longitude], 12);
      L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=EQtP0E2R31WbTGk6hOcg', {
          attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
      }).addTo(map);
      L.control.scale().addTo(map);
      markersLayer.addTo(map);
    }

    function loadView() {
        setMap();   
    }

    window.onload = function() {loadView()}

    function focusOn(lat,long){
        map.flyTo(new L.LatLng(lat, long));
    }
    
    var curr_zipcode=''; 

    $('#zipcode').keyup(function (event) {
        if (event.keyCode==189 || event.keyCode==190 || event.keyCode==107 || event.keyCode==109)
            this.value = ''
        if(this.value.length==5){
            zipcode = $('#zipcode').val();
            if(curr_zipcode!==zipcode){
                makeValid();
                curr_zipcode=zipcode;
                getNGOSitesZipcode(zipcode);
            }
        }
    });

    $('#zipcode').keypress(function(event){
        if(this.value.length==5){
            return false;
        }else if(this.value.length<5){
            makeInvalid();
        }
    });

    function setData(data){
        result = Object.entries(data['sites']);
        locations = result.map(([key, value]) => value);
        latitude = data['centroid']['latitude'];
        longitude = data['centroid']['longitude'];
        focusOn(latitude,longitude);
        markPoints(locations);
    }

    function getNGOSitesZipcode(zipcode){
        clearView();
        $.ajax({
            url: "{% url 'reuse:fetch-ngo-locations' %}",
            type: "GET",
            async: false,
            data: {
                "type": "zipcode",
                "zipcode": $('#zipcode').val()
            },
            success: function (data) {
                if (data['err_flag']==true){
                    makeInvalid();
                }else{
                    setData(data);
                }
            }
        });
    }

    function makeInvalid() {
        $('#zipcode').addClass('is-invalid');
        $('#zipcode-feedback').removeClass('d-none');
    }

    function makeValid() {
        $('#zipcode').removeClass('is-invalid');
        $('#zipcode-feedback').addClass('d-none');
    }

    function getNGOSitesLocations(latitude,longitude){
        clearView();
        $.ajax({
            url: "{% url 'reuse:fetch-ngo-locations' %}",
            type: "GET",
            async: false,
            data: {
                "type": "live-location",
                "latitude": latitude,
                "longitude": longitude
            },
            success: function (data) {
                setData(data);
            }
        });
    }

    $('#btn-locate-me').click(function(){
        $('#zipcode').val('');
        makeValid();
        $.ajax({
          url: 'https://get.geojs.io/v1/ip/geo.json',
          type: 'GET',
          success: function (data) {
              getNGOSitesLocations(data['latitude'],data['longitude']);
          }
        });
    });
        $(function(){
            $("body").tooltip({ 
                selector: '[data-toggle=tooltip]', 
                container: '.wrapper'
            });
        });

        $('[data-href]').click(function(){
            console.log('hey');
            window.open($(this).attr('data-href'),'_blank');
        });
        
        $('#main').addClass('my-3 mb-5 pb-5');

</script>
{% endblock %}
